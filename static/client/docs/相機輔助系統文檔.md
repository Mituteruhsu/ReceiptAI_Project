# 📸 ReceiptAI 前端相機輔助系統 - 技術文檔

## 🎯 核心設計原則

### 一、「有限度」使用 AI 協助
- ✅ **前端**提供：清晰度提示、亮度建議、區域檢測
- ❌ **前端不做**：最終品質判定、發票有效性認證
- ✅ **後端**進行：完整的影像驗證、OCR 識別、最終決策

### 二、優雅降級策略
```
桌面/Android: getUserMedia() → 實時反饋
        ↓ 失敗
iPhone: input[capture] → 簡單模式
```

---

## 📁 檔案架構

```
static/client/js/
├─ stream_prefilter.js        # 智能觸發邏輯（5 幀連續 → 拍照）
├─ image_processor.js         # 影像分析（清晰度、亮度、對比、區域）
├─ camera_assist.js           # 實時輔助系統（UI 更新、訊息生成）
└─ main.js          # 主程式（相機控制、整合）
```

---

## 🔧 各模組功能詳解

### 1️⃣ image_processor.js（影像處理）

#### 清晰度計算 - Laplacian Variance
```javascript
const sharpness = imageProcessor.calculateSharpness(imageData);
// 返回: 0-100（越高越清晰）
// 原理: 計算二階導數的方差，梯度越多表示越清晰
```

**OpenCV 方案**（推薦）：
- 轉灰度 → Laplacian 濾波 → 計算方差 → 正規化
- 精度高，但需要 OpenCV.js 加載

**Fallback 方案**：
- 簡單邊界檢測（像素相鄰灰度差）
- 無需外部庫，精度較低

#### 亮度計算
```javascript
const brightness = imageProcessor.calculateBrightness(imageData);
// 返回: 0-255
// 理想範圍: 80-200（非常暗 < 50，過亮 > 220）
```

#### 對比度計算
```javascript
const contrast = imageProcessor.calculateContrast(imageData);
// 返回: 0-100
// 理想: > 40（太低表示發票難以識別）
```

#### 發票區域檢測
```javascript
const rect = imageProcessor.detectInvoiceArea();
// 返回: { x, y, width, height } 或 null
// 檢測條件:
// - 白色矩形區域
// - 面積 > 畫面 9%
// - 長寬比 0.5-3（排除細長形）
```

---

### 2️⃣ camera_assist.js（實時輔助）

#### 啟動實時分析
```javascript
cameraAssist.startRealTimeAnalysis();
// ✓ 啟動 requestAnimationFrame 迴圈
// ✓ 顯示輔助面板
// ✓ 實時更新品質指標
```

#### 訊息生成邏輯
```
清晰度:
  < 50  → ❌ 影像模糊
  50-70 → ⚠️ 請穩定相機
  > 70  → ✓ 清晰度良好

亮度:
  < 50  → ❌ 環境光線太暗
  50-80 → ⚠️ 光線不足
  > 220 → ⚠️ 過度曝光
  80-220 → ✓ 亮度適中

對比度:
  < 30  → ⚠️ 對比度低
  ≥ 30  → ✓ 對比度良好

發票區域:
  檢測到 → ✓ 已檢測到發票
  未檢測 → 📋 請將發票對準
```

---

### 3️⃣ stream_prefilter.js（智能觸發）

#### 工作原理
```
每一幀輸入
  ↓
檢查冷卻期（防止頻繁觸發）
  ↓
基本檢查（有效影像？）
  ↓
是否像發票？ (hit_count++)
  ↓
連續 5 幀匹配 → 觸發！
  ↓
進入冷卻期（30 幀 ≈ 1 秒）
```

#### 使用方式
```javascript
const prefilter = new StreamPreFilter(5, 30);
// 參數1: stableFrames = 5（連續多少幀觸發）
// 參數2: cooldownFrames = 30（冷卻時間）

if (prefilter.feed(canvas)) {
    // 觸發拍照
    capturePhoto();
}
```

---

### 4️⃣ main.js（主程式）

#### 相機啟動流程
```javascript
startCamera()
  ├─ 嘗試 getUserMedia()
  │   ├─ 成功 → 進入桌面模式（實時反饋）
  │   └─ 失敗 → 降級到檔案輸入（iPhone）
  ├─ 啟動 cameraAssist
  ├─ 初始化 StreamPreFilter
  └─ 啟動自動觸發檢測
```

#### 自動觸發檢測
```javascript
startAutoDetection()
  ↓ 每 100ms 檢查一次
  ↓ StreamPreFilter.feed(canvas)
  ↓
  當觸發時:
    ├─ 顯示提示訊息
    ├─ 延遲 300ms
    └─ 自動拍照 capturePhoto()
```

---

## 🎨 UI 指標解釋

### 品質指標條
```
┌─ 清晰度 ──────────────┐
│ ░░░░░░░░░░░░░░░░░░░░ │ 85
└────────────────────────┘

顏色:
🟢 綠色（≥ 閾值）  → 品質良好
🟡 橘色（警告範圍）→ 需要改進
🔴 紅色（< 錯誤值）→ 不可用
```

### 訊息列表
```
✓ 清晰度良好
✓ 亮度適中
✓ 對比度良好
✓ 已檢測到發票
```

---

## ⚙️ 配置參數

在 `camera_assist.js` 中調整：

```javascript
// 清晰度閾值
warningThreshold: 70  // 警告
errorThreshold: 90    // 錯誤

// 亮度閾值
brightnessTooLow: 50   // 太暗
brightnessLow: 80      // 略暗
brightnessTooHigh: 220 // 過亮

// 對比度閾值
contrastLow: 30        // 對比度低

// StreamPreFilter
stableFrames: 5        // 連續幀數
cooldownFrames: 30     // 冷卻幀數
```

---

## 🚀 使用流程

### 桌面用戶
```
1. 點擊「開啟相機」
   ↓
2. 允許相機權限
   ↓
3. 看到實時輔助面板
   ├─ 清晰度、亮度、對比度指標
   ├─ 發票檢測框線
   └─ 使用者提示訊息
   ↓
4. 自動觸發或手動拍照
   ↓
5. 看到預覽圖
   ↓
6. 上傳到後端進行最終驗證
```

### iPhone 用戶
```
1. 點擊「開啟相機」
   ↓
2. 被詢問「選擇相機或檔案」
   ↓
3. 使用 iOS 相機應用拍照
   ↓
4. 看到預覽圖
   ↓
5. 上傳到後端進行最終驗證
```

---

## 📊 品質評估標準

### 前端評估（輔助）
```
清晰度 ≥ 70 → 可拍照
亮度 80-200 → 可拍照
對比度 ≥ 40 → 可拍照
發票檢測 → 已找到 → 建議拍照
```

### 後端評估（最終）
```
✓ 完整的 OCR 識別
✓ 發票號碼提取
✓ 金額驗證
✓ 日期合法性檢查
```

---

## 🔒 安全性考慮

### 前端侷限
- 📱 無法竄改影像品質指標影響後端（靠 Base64 校驗）
- 🔍 無法偽造 EXIF 資訊（後端驗證）
- ✅ 用戶無法繞過後端驗證

### 後端職責
- ✓ 最終的影像完整性檢查
- ✓ OCR 識別準確度驗證
- ✓ 發票真實性驗證（號碼範圍、日期等）

---

## 🐛 除錯技巧

### 開發者工具
```javascript
// 控制台查看品質報告
console.log('品質報告:', imageProcessor.getQualityReport());

// 查看 StreamPreFilter 狀態
console.log('觸發狀態:', prefilterInstance);

// 查看相機輔助系統狀態
console.log('輔助系統:', cameraAssist);
```

### 常見問題

**Q: 為什麼看不到發票框線？**
```
A: OpenCV.js 可能未加載
   檢查: console.log(typeof cv)
   應返回: 'object'
```

**Q: 品質指標不更新？**
```
A: canvas 尚未初始化
   檢查: canvas.width > 0
```

**Q: 自動觸發沒有工作？**
```
A: StreamPreFilter 閾值可能過高
   調整: stableFrames 從 5 降低到 3
```

---

## 📈 性能最佳化

### 幀率控制
```javascript
// 不是每幀都分析 OpenCV
// 建議: 每 3 幀分析一次
if (frameCount % 3 === 0) {
    analyzeWithOpenCV();
}
```

### 記憶體管理
```javascript
// OpenCV Mat 必須 delete
src.delete();
gray.delete();
// ...
```

### 圖片大小限制
```javascript
// 限制 canvas 大小防止卡頓
const MAX_WIDTH = 1280;
const MAX_HEIGHT = 720;
```

---

## 📝 版本資訊

```
系統版本: 1.0
OpenCV: 4.x
瀏覽器支援:
  ✓ Chrome/Edge 60+
  ✓ Firefox 55+
  ✓ Safari 15+
  ✓ iPhone Safari
  ✗ IE 全系列
```

---

## 🎓 進一步改進方向

1. **AI 模型集成**
   - 使用 TensorFlow.js 進行發票分類
   - 光學字符識別（OCR）前端輔助

2. **實時語音反饋**
   - 語音提示「請穩定相機」
   - 增強可用性

3. **多影像模式**
   - 連續拍攝多張角度
   - 後端合成完整發票

4. **離線模式**
   - 本地暫存影像
   - 網路恢復後上傳

---

## 📞 技術支援

如有問題，請檢查：
1. 瀏覽器控制台是否有錯誤訊息
2. OpenCV.js 是否已加載
3. 攝像頭權限是否已授予
4. 網路連線是否正常

---

**⚠️ 重要提醒**
前端所有的品質檢測都是「輔助」，最終品質保證由後端進行。
不能依賴前端 AI 來保證識別可用性。

<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Receipt AI - Camera Assist</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>

<style>
#container { position: relative; width: 100%; max-width: 420px; }
video, canvas { width: 100%; }
#overlay {
  position: absolute;
  border: 3px dashed red;
  top: 0; left: 0;
  pointer-events: none;
}
#hint {
  margin-top: 8px;
  font-weight: bold;
}
</style>
</head>

<body>

<h2>ç™¼ç¥¨æ‹ç…§è¼”åŠ©ï¼ˆWebï¼‰</h2>

<input type="file" id="fileInput" accept="image/*" capture="environment">

<button onclick="startCamera()">ğŸ“· é–‹å•Ÿæ”åƒé ­</button>
<button onclick="captureFrame()">ğŸ“¸ æ‹ç…§</button>

<div id="container">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
  <div id="overlay"></div>
</div>

<div id="hint"></div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("overlay");
const hint = document.getElementById("hint");

let stream = null;

// ==========================
// é–‹å•Ÿæ”åƒé ­ï¼ˆå³æ™‚è¼”åŠ©ï¼‰
// ==========================
async function startCamera() {
  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
  });
  video.srcObject = stream;

  requestAnimationFrame(analyzeFrame);
}

// ==========================
// å³æ™‚å½±åƒåˆ†æï¼ˆè¼”åŠ©ç”¨ï¼‰
// ==========================
function analyzeFrame() {
  if (!video.videoWidth) {
    requestAnimationFrame(analyzeFrame);
    return;
  }

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);

  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

  const sharpness = calcSharpness(imageData);
  const brightness = calcBrightness(imageData);

  let messages = [];

  if (sharpness < 80) messages.push("è«‹é è¿‘æˆ–ä¿æŒç©©å®š");
  if (brightness < 80) messages.push("ç’°å¢ƒå…‰ç·šä¸è¶³");
  if (brightness > 200) messages.push("ç•«é¢éäº®");

  hint.textContent = messages.join(" / ") || "ç•«é¢è‰¯å¥½";

  if (typeof cv !== "undefined") {
    detectInvoiceContour();
  }

  requestAnimationFrame(analyzeFrame);
}

// ==========================
// æ¸…æ™°åº¦ï¼ˆLaplacian varianceï¼‰
// ==========================
function calcSharpness(imageData) {
  let src = cv.matFromImageData(imageData);
  let gray = new cv.Mat();
  let lap = new cv.Mat();

  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
  cv.Laplacian(gray, lap, cv.CV_64F);

  let mean = new cv.Mat();
  let std = new cv.Mat();
  cv.meanStdDev(lap, mean, std);

  const variance = std.doubleAt(0, 0) ** 2;

  src.delete(); gray.delete(); lap.delete();
  mean.delete(); std.delete();

  return variance;
}

// ==========================
// äº®åº¦åˆ¤æ–·
// ==========================
function calcBrightness(imageData) {
  let sum = 0;
  for (let i = 0; i < imageData.data.length; i += 4) {
    sum += imageData.data[i];
  }
  return sum / (imageData.data.length / 4);
}

// ==========================
// ç™¼ç¥¨è¼ªå»“åµæ¸¬ï¼ˆæœ€å¤§çŸ©å½¢ï¼‰
// ==========================
function detectInvoiceContour() {
  let src = cv.imread(canvas);
  let gray = new cv.Mat();
  let edges = new cv.Mat();

  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
  cv.Canny(gray, edges, 75, 200);

  let contours = new cv.MatVector();
  let hierarchy = new cv.Mat();
  cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

  let best = null;
  let maxArea = 0;

  for (let i = 0; i < contours.size(); i++) {
    let rect = cv.boundingRect(contours.get(i));
    let area = rect.width * rect.height;
    if (area > maxArea) {
      maxArea = area;
      best = rect;
    }
  }

  if (best) {
    overlay.style.width = best.width + "px";
    overlay.style.height = best.height + "px";
    overlay.style.left = best.x + "px";
    overlay.style.top = best.y + "px";
  }

  src.delete(); gray.delete(); edges.delete();
  contours.delete(); hierarchy.delete();
}

// ==========================
// æ‹ç…§ï¼ˆä¿ç•™åŸåœ–çµ¦å¾Œç«¯ï¼‰
// ==========================
function captureFrame() {
  ctx.drawImage(video, 0, 0);
  stream.getTracks().forEach(t => t.stop());
  alert("å·²æ‹ç…§ï¼Œå¯é€å¾Œç«¯åˆ†æ");
}
</script>

</body>
</html>
